<!doctype html>
<html lang="bs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FIRECUBE â€“ Fire & Smoke Monitoring</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --bg:#0b0f17;
      --card:#111827;
      --card2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:#1f2937;
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --accent:#fb7185;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --r: 16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:var(--text);background:linear-gradient(180deg,#060912, #0b0f17);}
    .app{display:grid;grid-template-columns: 380px 1fr; height:100vh;}
    .sidebar{border-right:1px solid var(--line); padding:16px; background:rgba(17,24,39,.75); backdrop-filter: blur(10px); overflow:auto;}
    .main{display:grid; grid-template-rows: 72px 1fr;}
    .topbar{display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid var(--line); background:rgba(17,24,39,.55); backdrop-filter: blur(10px);}
    #map{height:100%;}

    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:42px;height:42px;border-radius:12px;
      background: radial-gradient(circle at 30% 30%, #ffedd5, #fb7185 45%, #7c3aed 100%);
      box-shadow: var(--shadow);
      position:relative; overflow:hidden;
    }
    .logo:after{content:""; position:absolute; inset:-10px; background: conic-gradient(from 220deg, rgba(255,255,255,.0), rgba(255,255,255,.25), rgba(255,255,255,0)); transform: rotate(25deg);}
    .brand h1{font-size:16px; margin:0; letter-spacing:.3px;}
    .brand .sub{font-size:12px; color:var(--muted); margin-top:2px;}

    .menu{display:flex; gap:10px; align-items:center;}
    .btn{border:1px solid var(--line); background:rgba(15,23,42,.7); color:var(--text); padding:9px 12px; border-radius:12px; cursor:pointer;}
    .btn:hover{border-color:#334155}
    .chip{padding:7px 10px; border-radius:999px; border:1px solid var(--line); background:rgba(15,23,42,.65); color:var(--muted); font-size:12px;}

    .card{background: linear-gradient(180deg, rgba(17,24,39,.9), rgba(15,23,42,.9)); border:1px solid var(--line); border-radius: var(--r); box-shadow: var(--shadow);}
    .sectionTitle{font-size:12px; color:var(--muted); margin:14px 0 8px;}
    .list{display:flex; flex-direction:column; gap:10px; margin-top:10px;}
    .item{padding:12px; border-radius:14px; border:1px solid var(--line); background:rgba(15,23,42,.75); cursor:pointer;}
    .item:hover{border-color:#334155}
    .item.active{outline:2px solid rgba(251,113,133,.55); border-color: rgba(251,113,133,.55);}
    .row{display:flex; justify-content:space-between; align-items:center; gap:10px;}
    .id{font-weight:700; font-size:13px}
    .meta{font-size:12px; color:var(--muted); margin-top:6px}
    .pill{font-size:12px; padding:5px 9px; border-radius:999px; border:1px solid var(--line);}
    .pill.good{color:#bbf7d0; background:rgba(22,163,74,.12); border-color:rgba(22,163,74,.35)}
    .pill.warn{color:#fde68a; background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.35)}
    .pill.bad{color:#fecaca; background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.35)}

    .detail{padding:14px;}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;}
    .kpi{padding:12px; border:1px solid var(--line); border-radius:14px; background:rgba(2,6,23,.35)}
    .kpi .k{font-size:11px; color:var(--muted)}
    .kpi .v{font-size:18px; font-weight:800; margin-top:6px}
    .small{font-size:12px;color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    .leaflet-popup-content-wrapper{border-radius:14px; background: rgba(17,24,39,.95); color:var(--text); border:1px solid rgba(31,41,55,.9)}
    .leaflet-popup-tip{background: rgba(17,24,39,.95)}
    .popupTitle{font-weight:800; margin-bottom:8px}
    .popupLine{font-size:12px; color:var(--muted); margin-top:4px}
    .popupBadge{display:inline-block; margin-top:10px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); font-size:12px;}

    /* history */
    .history{padding:12px;}
    .hrow{padding:10px; border-radius:12px; border:1px solid var(--line); background:rgba(2,6,23,.25); margin-top:10px;}
    .hrow .top{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .hrow .t1{font-weight:800;font-size:13px}
    .hrow .t2{font-size:12px;color:var(--muted)}

    /* ===== ALARM UI ADDITIONS ===== */
    .alarmOverlay{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(3px);
      z-index:9999;
    }
    .alarmOverlay.hidden{ display:none; }

    .alarmBox{
      width:min(680px, 92vw);
      border-radius: 18px;
      border: 2px solid rgba(239,68,68,.85);
      background: linear-gradient(180deg, rgba(127,29,29,.95), rgba(15,23,42,.92));
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
      padding: 18px 18px 14px;
      animation: pulse 1.1s infinite;
    }
    .alarmTitle{
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .4px;
    }
    .alarmText{
      margin-top: 10px;
      color: #fecaca;
      font-size: 13px;
      line-height: 1.4;
    }
    @keyframes pulse{
      0%{ transform: scale(1); box-shadow: 0 18px 50px rgba(0,0,0,.55); }
      50%{ transform: scale(1.02); box-shadow: 0 22px 70px rgba(239,68,68,.35); }
      100%{ transform: scale(1); box-shadow: 0 18px 50px rgba(0,0,0,.55); }
    }

    .alarmBanner{
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(239,68,68,.7);
      background: rgba(239,68,68,.18);
      color: #fecaca !important;
      font-weight: 900;
      letter-spacing: .4px;
      animation: blink 1.1s infinite;
    }
    @keyframes blink{
      0%,100%{ filter: brightness(1); }
      50%{ filter: brightness(1.6); }
    }
  </style>
</head>

<body>
  <!-- ===== ALARM OVERLAY (NEW) ===== -->
  <div id="alarmOverlay" class="alarmOverlay hidden">
    <div class="alarmBox">
      <div class="alarmTitle">ðŸ”¥ ALARM â€“ DETEKTOVAN DIM / POÅ½AR</div>
      <div class="alarmText" id="alarmText">--</div>
      <button class="btn" id="btnSilence">UtiÅ¡aj zvuk</button>
    </div>
  </div>

  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>FIRECUBE</h1>
          <div class="sub">Monitoring dima i lokacije</div>
        </div>
      </div>

      <div class="sectionTitle">Izbor ureÄ‘aja</div>
      <div id="deviceList" class="list"></div>

      <div class="sectionTitle">Detalji</div>
      <div class="card detail" id="detailCard">
        <div class="small">Klikni ureÄ‘aj ili marker na mapi.</div>
        <div class="grid2">
          <div class="kpi">
            <div class="k">Smoke</div>
            <div class="v" id="dSmoke">--</div>
          </div>
          <div class="kpi">
            <div class="k">Alarm</div>
            <div class="v" id="dAlarm">--</div>
          </div>
          <div class="kpi">
            <div class="k">GPS</div>
            <div class="v mono" style="font-size:13px" id="dGps">--</div>
          </div>
          <div class="kpi">
            <div class="k">Status</div>
            <div class="v" id="dOnline">--</div>
          </div>
        </div>
        <div class="small" style="margin-top:10px">
          Zadnji update: <span class="mono" id="dTime">--</span>
        </div>
      </div>

      <div class="sectionTitle">History log alarma</div>
      <div class="card history">
        <div class="small">BiljeÅ¾i ALARM ON/OFF po ureÄ‘aju (promjena stanja).</div>
        <div id="alarmList"></div>
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="menu">
          <button class="btn" id="btnFit">Fit mapa</button>
          <button class="btn" id="btnCenter">Centar na odabrani</button>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <div class="chip" id="globalStatus">Status: --</div>
          <div class="chip mono" id="count">UreÄ‘aji: 0</div>
        </div>
      </header>
      <div id="map"></div>
    </main>
  </div>

  <script>
    const map = L.map('map').setView([43.8563, 18.4131], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);

    const markers = new Map();
    let selectedId = null;
    let lastDevices = [];

    const elList = document.getElementById("deviceList");
    const elCount = document.getElementById("count");
    const elGlobalStatus = document.getElementById("globalStatus");

    const elDSmoke = document.getElementById("dSmoke");
    const elDAlarm = document.getElementById("dAlarm");
    const elDGps = document.getElementById("dGps");
    const elDOnline = document.getElementById("dOnline");
    const elDTime = document.getElementById("dTime");

    const elAlarmList = document.getElementById("alarmList");

    document.getElementById("btnFit").onclick = () => fitMap();
    document.getElementById("btnCenter").onclick = () => centerSelected();

    function fmtTime(ts){ if (!ts) return "--"; return new Date(ts).toLocaleString(); }
    function isOnline(ts){ return !!ts && (Date.now() - ts) <= 15000; }

    function popupHtml(d){
      const online = isOnline(d.timestamp);
      const badgeCls = d.alarm ? "bad" : (online ? "good" : "warn");
      const badgeText = d.alarm ? "ALARM" : (online ? "ONLINE" : "OFFLINE");
      const gps = (typeof d.lat === "number" && typeof d.lon === "number") ? `${d.lat.toFixed(6)}, ${d.lon.toFixed(6)}` : "N/A";
      return `
        <div class="popupTitle">${d.device_id}</div>
        <div class="popupLine">Smoke: <b>${d.smoke ?? "--"}</b></div>
        <div class="popupLine">GPS: <span class="mono">${gps}</span></div>
        <div class="popupLine">Update: <span class="mono">${fmtTime(d.timestamp)}</span></div>
        <div class="popupLine">Source: <span class="mono">${d.source ?? "?"}</span></div>
        <div class="popupBadge ${badgeCls}">${badgeText}</div>
      `;
    }

    function renderList(devs){
      elList.innerHTML = "";
      devs.forEach(d => {
        const item = document.createElement("div");
        item.className = "item" + (d.device_id === selectedId ? " active" : "");
        item.onclick = () => selectDevice(d.device_id);

        const online = isOnline(d.timestamp);
        const cls = d.alarm ? "bad" : (online ? "good" : "warn");
        const status = d.alarm ? "ALARM" : (online ? "ONLINE" : "OFFLINE");

        item.innerHTML = `
          <div class="row">
            <div class="id">${d.device_id}</div>
            <div class="pill ${cls}">${status}</div>
          </div>
          <div class="meta">
            Smoke: <span class="mono">${d.smoke ?? "--"}</span> Â·
            Update: <span class="mono">${fmtTime(d.timestamp)}</span>
          </div>
        `;
        elList.appendChild(item);
      });
      elCount.textContent = `UreÄ‘aji: ${devs.length}`;
    }

    function selectDevice(id){
      selectedId = id;
      renderList(lastDevices);
      updateDetail(lastDevices.find(x => x.device_id === id) || null);
      centerSelected();
    }

    function updateDetail(d){
      if (!d){
        elDSmoke.textContent = "--";
        elDAlarm.textContent = "--";
        elDGps.textContent = "--";
        elDOnline.textContent = "--";
        elDTime.textContent = "--";
        return;
      }
      elDSmoke.textContent = (d.smoke ?? "--");
      elDAlarm.textContent = d.alarm ? "DA" : "NE";
      const gps = (typeof d.lat === "number" && typeof d.lon === "number") ? `${d.lat.toFixed(6)}, ${d.lon.toFixed(6)}` : "N/A";
      elDGps.textContent = gps;
      elDOnline.textContent = isOnline(d.timestamp) ? "ONLINE" : "OFFLINE";
      elDTime.textContent = fmtTime(d.timestamp);
    }

    function fitMap(){
      const pts = [];
      markers.forEach(m => pts.push(m.getLatLng()));
      if (!pts.length) return;
      map.fitBounds(L.latLngBounds(pts).pad(0.25));
    }

    function centerSelected(){
      if (!selectedId) return;
      const m = markers.get(selectedId);
      if (!m) return;
      map.setView(m.getLatLng(), Math.max(map.getZoom(), 14));
      m.openPopup();
    }

    function renderHistory(list){
      elAlarmList.innerHTML = "";
      if (!list || !list.length){
        elAlarmList.innerHTML = `<div class="small" style="margin-top:10px">Nema dogaÄ‘aja joÅ¡.</div>`;
        return;
      }

      list.slice(0, 30).forEach(e => {
        const row = document.createElement("div");
        row.className = "hrow";
        const badgeCls = e.type === "ALARM_ON" ? "bad" : "good";
        row.innerHTML = `
          <div class="top">
            <div class="t1">${e.device_id}</div>
            <div class="pill ${badgeCls}">${e.type}</div>
          </div>
          <div class="t2">
            Smoke: <span class="mono">${e.smoke ?? "--"}</span> Â·
            ${fmtTime(e.timestamp)} Â· source: <span class="mono">${e.source ?? "?"}</span>
          </div>
        `;
        elAlarmList.appendChild(row);
      });
    }

    // ===== ALARM overlay + sound (NEW) =====
    let prevAnyAlarm = false;
    let soundMuted = false;

    const overlay = document.getElementById("alarmOverlay");
    const alarmText = document.getElementById("alarmText");
    const btnSilence = document.getElementById("btnSilence");

    btnSilence.onclick = () => {
      soundMuted = true;
      overlay.classList.add("hidden");
    };

    function playAlarmBeep(){
      if (soundMuted) return;
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioContext();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine";
      o.frequency.value = 880;
      g.gain.value = 0.08;
      o.connect(g);
      g.connect(ctx.destination);
      o.start();
      setTimeout(() => { o.stop(); ctx.close(); }, 450);
    }

    async function tick(){
      try{
        const [rDev, rAlm] = await Promise.all([
          fetch("/api/devices", { cache:"no-store" }),
          fetch("/api/alarms", { cache:"no-store" })
        ]);

        const devs = await rDev.json();
        const alarms = await rAlm.json();

        devs.sort((a,b) => {
          const aa = a.alarm ? 1 : 0;
          const bb = b.alarm ? 1 : 0;
          if (bb !== aa) return bb - aa;
          return (b.timestamp||0) - (a.timestamp||0);
        });

        lastDevices = devs;
        if (!selectedId && devs.length) selectedId = devs[0].device_id;

        renderList(devs);
        renderHistory(alarms);

        const anyAlarm = devs.some(d => d.alarm);

        // Global status text/colors
        elGlobalStatus.textContent = anyAlarm ? "Status: ALARM" : "Status: OK";
        elGlobalStatus.style.borderColor = anyAlarm ? "rgba(239,68,68,.55)" : "rgba(22,163,74,.55)";
        elGlobalStatus.style.color = anyAlarm ? "#fecaca" : "#bbf7d0";

        // Banner blink class
        if (anyAlarm) elGlobalStatus.classList.add("alarmBanner");
        else elGlobalStatus.classList.remove("alarmBanner");

        // Show overlay + beep only on OFF->ON transition
        if (anyAlarm && !prevAnyAlarm) {
          const alarmDevs = devs.filter(d => d.alarm);
          const first = alarmDevs[0];

          let gpsLine = "GPS: N/A";
          if (typeof first.lat === "number" && typeof first.lon === "number") {
            gpsLine = `GPS: ${first.lat.toFixed(6)}, ${first.lon.toFixed(6)}`;
          }

          alarmText.textContent =
            `UreÄ‘aj: ${first.device_id} | Smoke: ${first.smoke} | ${gpsLine} | Vrijeme: ${new Date(first.timestamp).toLocaleString()}`;

          overlay.classList.remove("hidden");
          playAlarmBeep();

          selectedId = first.device_id;
          renderList(lastDevices);
          updateDetail(first);
          centerSelected();
        }

        if (!anyAlarm) {
          overlay.classList.add("hidden");
        }

        // Update markers
        devs.forEach(d => {
          const hasGps = (typeof d.lat === "number" && typeof d.lon === "number");
          if (!hasGps) return;

          const pos = [d.lat, d.lon];
          if (!markers.has(d.device_id)){
            const m = L.marker(pos).addTo(map);
            m.bindPopup(popupHtml(d), { closeButton:true, autoClose:false });
            m.on("click", () => {
              selectedId = d.device_id;
              renderList(lastDevices);
              updateDetail(d);
            });
            markers.set(d.device_id, m);
          } else {
            const m = markers.get(d.device_id);
            m.setLatLng(pos);
            m.setPopupContent(popupHtml(d));
          }
        });

        updateDetail(devs.find(x => x.device_id === selectedId) || null);

        prevAnyAlarm = anyAlarm;

      } catch(e){
        elGlobalStatus.textContent = "Status: ERROR";
        elGlobalStatus.style.borderColor = "rgba(245,158,11,.55)";
        elGlobalStatus.style.color = "#fde68a";
      }
    }

    tick();
    setInterval(tick, 2000);
  </script>
</body>
</html>
